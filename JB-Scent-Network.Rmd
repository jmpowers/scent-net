---
title: "JB-Scent-Net"
author: "Janelle Bohey"
date: "2023-11-28"
output: 
  html_document:
    code_folding: hide
    toc: yes
    toc_float: TRUE
    self_contained: no
editor_options: 
  chunk_output_type: console
---

```{r setup}
knitr::opts_chunk$set(echo = TRUE, comment="  ", cache=TRUE, warning=FALSE, message=FALSE, fig.width=14, fig.asp=.678)
library(openxlsx)
library(data.table)
library(RColorBrewer)
pal <- brewer.pal(5,"Set2")
#library(heatmaply)
library(bipartite)
data(mosquin1967)
library(vegan)
library(phytools)
library(taxize)
#remotes::install_github("ropensci/brranching")
library(brranching)
library(rotl)
library(dendextend)
library(tidyverse)
library(heatmaply)
library(googlesheets4)

```

#load network
```{r, data}
#load network
setwd("~/Desktop/Scent-Net")
gs4_auth(email=TRUE)
net.long <- read_sheet("1plhxbVh5IQLNVMazqO4OvfM3X6vbll_Y6BTMJ94bkI4", na=c("","na", "NA")) %>%    
      mutate(pollinator_group= if_else(pollinator=="papilio_gothica", "butterfly", pollinator_group)) %>% #fix papilio_gothica from bee -> butterfly
      mutate(plant= recode(plant,senecio_tall_int = "senecio_integerrimus", agoceris_glauca = "agoseris_glauca", agoceris_aurantiaca="agoseris_aurantiaca", hydrophyllum_fendeleri="hydrophyllum_fendleri"))



net <- net.long %>% select(plant, pollinator, interactions) %>% pivot_wider(names_from = plant, values_from = interactions, values_fn= sum, values_fill= 0) %>%  #pivots data set longer so plants as columns and pollinators as rows, replaces NAs with zeros
    column_to_rownames("pollinator") #pollinators are in first column, makes them into rownames; #deletes the first pollinators column


net <- as.matrix(t(net)) # turns it from dataframe to matrix bc packages like matrix; t transposes (turns dataset sideways - rows -> columns; columns -> rows) 
polls <- colnames(net) #now pollinators are column names
plants<-rownames(net)
snet <- sortweb(net) #sort by row & column totals; sorted rows by rowsums and columns by column sums. Biggest numbers in top left of matrix
```

#load scent 
```{r, load scent}

#Go to comm_vols for code to make scent.net
#Loads in vol, filters with bouquet, takes mean of each voc for each species 
#From comm_vols.Rmd
scent.net <- read_csv("data/Volatiles_by_species_mean.csv") %>% column_to_rownames("species") %>% #species are now rownames
    as.matrix()   #network analysis likes matrix 
    
scent.net <- scent.net[,colnames(scent.net)!="Cyclohexane, 1,3,5-trimethyl-2-octadecyl-"] #filtering this compound bc it has 0 interactions or emissions... 355 vs 354. breaks code later

#loads in chemical class and gets rid of ?
compound.class <-read_sheet("1BlDIOs4STe5ZTTPYE6qez1Nsey_ovEpe5m-SN8Q55gg", sheet= "chemical_class") %>% mutate(major_class= factor(major_class,levels=c("aliphatic", "monoterpene", "sesquiterpene", "nitrogenous", "sulfur", "benzenoid")) %>% fct_na_value_to_level("other")) %>% 
      filter(compound_long!="Cyclohexane, 1,3,5-trimethyl-2-octadecyl-") #filtering this compound bc it has 0 interactions or emissions... 355 vs 354

#codes chemical class by colors
voc.class.colors <- setNames(brewer.pal(7,"Set3"), levels(compound.class$major_class))


```

##match paul's plants with the plants we have vocs for
```{r, "match paul's plants with the plants we have vocs for" }
scentplants<-rownames(scent.net) #%>% tolower() %>%  str_replace(" ", "_")

paulsplants <- plants

#plants not in both datasets 
setdiff(scentplants, paulsplants) #gives us bonus plants
setdiff(paulsplants, scentplants) 

bothplants <- intersect(scentplants, paulsplants) #plants found in amanda and paul data
```


# Pollinator groups and family

```{r, Pollinator groups and family}
polls.count <-count(net.long, pollinator_group,pollinator_family, pollinator) #counting number of rows for each pollinator
polls.class <- tibble(pollinator=polls) %>%  left_join(polls.count) %>% pull(pollinator_group)
polls.class.dataframe <- tibble(pollinator=polls) %>%  left_join(polls.count)
polls.family <- tibble(pollinator=polls) %>%  left_join(polls.count) %>% pull(pollinator_family)
polls.order.all <- polls.class

#net.grp.all has all of pauls 45 plant species 
#net.grp only has plant species found in Amanda's and paul's datasets
net.grp.all <- aggregate(.~ polls.class, as.data.frame(t(net)), sum) #lump network by pollinator class; plants columns, pollinators rows
rownames(net.grp.all) <- net.grp.all[,1] #make plants rows, pollinators column names
net.grp.all[,1] <- NULL
net.grp.all <- as.matrix(t(net.grp.all)) #transposes matrix
net.grp<- net.grp.all[bothplants,] 

net.cut <- net[bothplants,]

```


# Plant-pollinator network

##Pollinator groups
```{r, pollinator groups}
#Tells you plants major pollinator
plants.majorpoll <- setNames(factor(colnames(net.grp)[apply(net.grp, 1, which.max)]), rownames(net.grp))

#sets colors for ALL 5 pollinator groups
pcols.all <- setNames(brewer.pal(5,"Set2"), colnames(net.grp))

#Four colors for each major pollinator group
pcols <- pcols.all[ levels(plants.majorpoll)]

```

# Proportion of visits by pollinator group
```{r, Proportion of visits by pollinator group}
#gives % bee pollination for each plant species 
plants.bees <- net.grp[,"bee"]/rowSums(net.grp)
plot(sort(plants.bees))

scent.net.cut <- scent.net[rownames(scent.net)%in% paulsplants, ] #cuts scent to match what paul has pollinator data for

# Cap of plants.bees
plant.bee.cap <- capscale(sqrt(scent.net.cut)~plants.bees)
anova(plant.bee.cap)
#p=0.348
plot(plant.bee.cap, type="text")

#gives % fly pollination for each plant species 
plants.fly <- net.grp[,"fly"]/rowSums(net.grp)
plot(sort(plants.fly))
sort(plants.fly)

#gives % butterfly pollination for each plant species 
plants.butterfly <- net.grp[,"butterfly"]/rowSums(net.grp)
plot(sort(plants.butterfly))
sort(plants.butterfly)

#gives % hummingbird pollination for each plant species 
plants.hummingbird <- net.grp[,"hummingbird"]/rowSums(net.grp)
plot(sort(plants.hummingbird))
sort(plants.hummingbird)

#gives % wasp pollination for each plant species 
plants.wasp <- net.grp[,"wasp"]/rowSums(net.grp)
plot(sort(plants.wasp))
sort(plants.wasp)
```


##Heatmap1
```{r, pp-heatmap, fig.asp=1}

#pp_heatmap
heatmaply(net, scale="none", showticklabels = c(F,T), margins= c(0,NA,0,0),
          scale_fill_gradient_fun = ggplot2::scale_fill_gradient(low = "white", high = "#000050", trans="log1p"),
          distfun=vegdist, 
          hclustfun=function(x) hclust(x, method="mcquitty"), 
          row_side_colors = data.frame(P=plants.majorpoll[rowSums(net)>0]),
          row_side_palette=function(n) pcols, 
          col_side_colors=data.frame(PollinatorGroup=polls.class), 
          col_side_palette=function(n) pcols.all)
```

##Matrix plot
```{r matrixplot, fig.asp=.2}
#interaction matrix plot
visweb(net, type="nested", circles=T, boxes=F, circle.max=1.2)
```

##Web plot
```{r webplot, fig.height=15, fig.width=18}

#fix names of species (plants rows, polls cols)
net.nice.labels <- net
rownames(net.nice.labels) <- str_to_sentence(str_replace_all(rownames(net), "_"," "))
colnames(net.nice.labels) <- str_to_sentence(str_replace_all(colnames(net), "_"," "))

#interaction web plot
par(mar=c(0,0,0,0))
plant.pollinator.network <- plotweb(sqrt(net.nice.labels), empty=F, text.rot=90, method="cca", col.high=pcols.all[polls.order.all], col.low=pcols[plants.majorpoll], col.interaction=pcols.all[polls.order.all], bor.col.interaction=pcols.all[polls.order.all], bor.col.high=pcols.all[polls.order.all], bor.col.low=pcols[plants.majorpoll])

library(ggplot2)
ggsave(plant.pollinator.network, file='plant.pollinator.networkplot.jpg', width=130, height=105, units= 'mm', dpi=600)

```


# Network topography
```{r Network topo}
#computes network statistics (like nestedness)
#networkstats <- networklevel(net)
#write_csv(enframe(networkstats), "data/p-p network stats.csv")

#computes network statistics for voc-pollinator network
#scentnetworkstats<- networklevel(scentpollnet)
#write_csv(enframe(scentnetworkstats), "data/scent network stats.csv")
scentnet.stats <- read_csv("data/scent network stats.csv")

#the network statistics null model: TODO- broken
#network.nullmodel<-nullmodel(scentpollnet) 
#nullmodel.stats<- map(network.nullmodel, ~networklevel(.x )) #network.nullmodel[1:2]; index=c("NODF", "weighted NODF", "connectance", "H2", "modularity Q")

#nullmodel.stats %>% map_dfr(~enframe(.x), .id = "run") %>% write_csv("data/scent network null model statistics.csv")
nullmodel.stats <- read_csv("data/scent network null model statistics.csv")

#idea - pivot wider so network properties are the columns, rows are run number, then average by values in column -> pivot longer or store in new variable
#nullmodel.stats %>% pivot_wider(names_from = "Name", values_from = "Value") %>% column_to_rownames("stats") %>% as.matrix()

null.NODF <- read_csv("data/scent network null model statistics.csv") %>% filter(name=="NODF")
ggplot(null.NODF, aes(x=value))+ geom_histogram() + geom_vline(aes(xintercept=filter(scentnet.stats, name=="NODF") %>% pull(value)))

```

# Scent network
##Heatmap2
```{r scent-net heatmap.s, fig.asp=1}
scent.net.cut <- scent.net[rownames(scent.net)%in% paulsplants, ] #cuts scent to match what paul has pollinator data for
plants.majorpoll.cut <- plants.majorpoll[rownames(scent.net.cut)] #cuts Pauls data to match Amanda's

plants.bees.cut<- plants.bees[rownames(scent.net.cut)]

heatmaply(sqrt(scent.net.cut), scale="none", showticklabels = c(F,T), margins= c(0,NA,0,0),
          scale_fill_gradient_fun = ggplot2::scale_fill_gradient(low = "white", high = "#000050", trans="log1p"),
          distfun=vegdist, 
          hclustfun=function(x) hclust(x, method="mcquitty"), 
          row_side_colors = data.frame(major.polls=plants.majorpoll.cut),
          row_side_palette=function(n) pcols )
          #col_side_colors=data.frame(PollinatorGroup=scent.net), #put compound class here
        #  col_side_palette=function(n) pcols.all)

```

## Distance Matrix (for bray curtis distance)
### Mantel test
```{r, distance matrix & mantel test}
#scent-plant network 
distance.matrix <- vegdist(sqrt(scent.net.cut))
View(as.matrix(distance.matrix)) #tells you how different the smells are. If 0 there is no difference, scents are the same; 1 = no compounds in common

#plant-pollinator network
#how similar are the plants in terms of their pollinator array/composition
distance.matrix.pp <- vegdist(net.cut)
View(as.matrix(distance.matrix.pp))

#Mantel Test
#can do correlation, if scent similarity predicts pollinator --> mantel test
mantel(distance.matrix,distance.matrix.pp)

#TODO: group by family then rerun vegdist

distance.matrix.pollgroup <- vegdist(net.grp)
mantel(distance.matrix, distance.matrix.pollgroup) 
#can't predict which pollinator group will visit plant based on VOCS


#relative amounts of visits from pollinator groups 
distance.matrix.pollgroup.relative <- vegdist(decostand(net.grp, method="tot"))
mantel(distance.matrix, distance.matrix.pollgroup.relative) 

#similarity of the relative amounts of scent of each plant
distance.matrix.relative <- vegdist(sqrt(decostand(scent.net.cut, method="tot")))

#is similarity of the relative amounts of scent of each plant correlated with the similarity in relative visits from each pollinator group
mantel(distance.matrix.relative, distance.matrix.pollgroup.relative)


#No correlation between scent similarity and similarity of the proportion of visits by pollinators or pollinator group (p> 0.1)


#not grouped by pollinator class but still relative
distance.matrix.pp.relative <- vegdist(decostand(net.cut, method="tot"))
mantel(distance.matrix.relative, distance.matrix.pp.relative)
```


## Web plot VOCs-Plants
```{r VOC-plant webplot.s}
#interaction web plot
#plant-voc bipartite
plotweb(sqrt(scent.net), text.rot=90, method="cca", col.high=voc.class.colors[compound.class$major_class], bor.col.high=voc.class.colors[compound.class$major_class], col.low=pcols[plants.majorpoll], bor.col.low=pcols[plants.majorpoll], col.interaction=pal[5], bor.col.interaction=pal[5])


```


# Plant-scent-pollinator network
## NMDS
```{r, nmds}
scent.net.cut <- scent.net[rownames(scent.net)%in% paulsplants, ]
scent.mds <- metaMDS(sqrt(scent.net.cut), autotransform = F, trace=F)
scent.op <- ordiplot(scent.mds, type="n")
points(scent.op, what="species", pch=3, col="grey50")
points(scent.op, what="sites", cex=1.5, pch=19, col=pcols[plants.majorpoll])
text(scent.op, what="sites", cex=0.8, col=pcols[plants.majorpoll])

#are scents of plants with different major pollinators different? no... 
#do phylogeny, plants in same genus will cluster together need to account for phylogeny
```

## cap
```{r, cap}
scent.cap <- capscale(sqrt(scent.net.cut)~plants.majorpoll.cut)
anova(scent.cap)

plot(scent.cap, type="text")
```


## Indicator compounds
```{r, indicator compounds}
library(indicspecies)

plants.majorpoll.cut <- plants.majorpoll[rownames(scent.net.cut)]
  
mp <- multipatt(as.data.frame(scent.net.cut), plants.majorpoll.cut, control=how(nperm=999))
summary(mp)
```

# Shannon diversity

```{r, generalists}
###Do generalist plants have higher diversity of scent compounds?
plants.numlinks  <- rowSums(decostand(net.cut, "pa"))
#polls.classtree <- compute.brlen(polls.classtree$phylo,1)
#library(picante)
#plants.pdlinks   <- pd(net.lump, polls.classtree)$PD
plants.numcompounds <- rowSums(decostand(scent.net.cut, "pa"))
plants.sumcompounds <- rowSums(scent.net.cut)
plants.shannoncompounds <- diversity(scent.net.cut, index="shannon")
plants.shannonlinks <- diversity(net.cut, index="shannon")

scent.diversity <- tibble(numlinks=plants.numlinks, numcompounds=plants.numcompounds, sumcompounds=plants.sumcompounds, shannoncompounds=plants.shannoncompounds, shannonlinks=plants.shannonlinks, plant=rownames(net.cut))

ggplot(scent.diversity, aes(y=numcompounds, x=numlinks))+
    geom_point()+ geom_smooth() + ylim(c(0, NA)) + geom_text(aes(label=plant))
#probably driven by heterotheca 

anova(lm(numlinks~numcompounds, data=scent.diversity))

#tells us if plants with more diverse scent get more pollinator species
anova(lm(plants.numlinks~shannoncompounds, data=scent.diversity))
#plot(plants.numcompounds~plants.pdlinks)

#plot(plants.shannoncompounds~plants.pdlinks)

(shannon.compoundxlinks.plot <- ggplot(scent.diversity, aes(y=shannonlinks, x=shannoncompounds))+
    geom_point()+ geom_smooth())
ggsave(shannon.compoundxlinks.plot, file='shannon.compoundxlinks.plot.jpg', width=130, height=105, units= 'mm', dpi=300)

(compoundxlinks.plot <- ggplot(scent.diversity, aes(y=plants.numlinks, x=shannoncompounds))+
    geom_point()+ geom_smooth())
ggsave(compoundxlinks.plot, file='compoundxlinks.plot.jpg', width=130, height=105, units= 'mm', dpi=300)

(shannon.compound.plot <- ggplot(scent.diversity, aes(y=shannoncompounds, x=plants.majorpoll.cut))+
    geom_point()+ geom_smooth())
ggsave(shannon.compound.plot, file='shannon.compound.plot.jpg', width=110, height=105, units= 'mm', dpi=300)

(numcompounds.plot <-ggplot(scent.diversity, aes(y=numcompounds, x=plants.majorpoll.cut))+
    geom_point()+ geom_smooth())
ggsave(numcompounds.plot, file='numcompounds.plot.jpg', width=110, height=105, units= 'mm', dpi=300)

(sumcompounds.plot<- ggplot(scent.diversity, aes(y=sumcompounds, x=plants.majorpoll.cut))+
    geom_point()+ geom_smooth())
ggsave(sumcompounds.plot, file='sumcompounds.plot.jpg', width=110, height=105, units= 'mm', dpi=300)


#top10
top10list <- c("heterotheca_villosa", "arenaria_congesta","heliomeris_multiflora", "erigeron_flagellaris", "galium_boreale", "delphinium_nuttalianum", "potentilla_hippiana", "claytonia_lanceolata", "erigonum_umbellatum")

top10 <-scent.diversity %>% filter(plant%in%top10list)
ggplot(top10, aes(y=numcompounds, x=numlinks))+
    geom_point()+ geom_smooth() + ylim(c(0, 500)) + geom_text(aes(label=plant))

```

# VOC-pollinator network
```{r, VOC-pollinator network}
#interaction web plot
#voc-pollinator bipartite

#make dataframe with vocs and pollinators
##change scent.net to long format
plantcompoundemission <- scent.net.cut %>% as.data.frame() %>% rownames_to_column("plant") %>% #average peak area
  pivot_longer(-plant, names_to = "compound", values_to = "emissions") %>% filter(emissions!=0)


#write_csv(plantcompoundemission, "plantcompoundemissions.csv")
 
#total number of visits to plant by each pollinator species
plantpollinatorvisits <- net.cut %>% as.data.frame() %>% rownames_to_column("plant") %>% pivot_longer(-plant, names_to = "pollinator", values_to = "visits")


#total number of visits to each compound. Pollinators rows, compounds cols, values = number of visits
scentpollnet <- left_join(plantcompoundemission, plantpollinatorvisits,relationship = "many-to-many") %>%  group_by(pollinator, compound) %>% summarise(visits=sum(visits)) %>%  pivot_wider(names_from = "compound", values_from = "visits") %>% column_to_rownames("pollinator") %>% as.matrix()


#relative amount of each compound
plantcompoundrelative <- scent.net.cut %>% as.data.frame() %>% decostand(method="tot") %>% rownames_to_column("plant") %>% #average peak area
  pivot_longer(-plant, names_to = "compound", values_to = "emissions") %>% filter(emissions!=0)

#multiply number of visits by relative peak area
# weights visit to compounds. Proportions visits based on how many VOCs there are.
scentpollnet.area <- left_join(plantcompoundrelative, plantpollinatorvisits,relationship = "many-to-many") %>%  group_by(pollinator, compound) %>% mutate(visits.area=visits*emissions) %>%  summarise(visits.area=sum(visits.area)) %>%  pivot_wider(names_from = "compound", values_from = "visits.area") %>% column_to_rownames("pollinator") %>% as.matrix()

scentpollnet.class <- tibble(pollinator=rownames(scentpollnet)) %>% left_join(polls.class.dataframe) %>% pull(pollinator_group)


#plot bipartite network
#plotweb(sqrt(scentpollnet), text.rot=90, method="cca", col.high=pal[2], bor.col.high=pal[2], #col.low=pcols[scentpollnet.class], bor.col.low=pcols[scentpollnet.class], col.interaction=pal[5], #bor.col.interaction=pal[5])

#plotweb for scentpollnet.area

plotweb(sqrt(scentpollnet.area), text.rot=90, method="cca", col.high=pal[2], bor.col.high=pal[2], col.low=pcols[scentpollnet.class], bor.col.low=pcols[scentpollnet.class], col.interaction=pal[5], bor.col.interaction=pal[5])

```

## Heatmap scent-net
```{r, voc-pollgroup heatmap, fig.asp=1}

#value = number of 
heatmaply(scentpollnet, scale="none", showticklabels = c(F,T), margins= c(0,NA,0,0),
          scale_fill_gradient_fun = ggplot2::scale_fill_gradient(low = "white", high = "#000050", trans="log1p"),
          distfun=vegdist, 
          hclustfun=function(x) hclust(x, method="mcquitty"), 
          #row_side_colors = data.frame(P=plants.majorpoll[rowSums(net)>0]),
          #row_side_palette=function(n) pcols, 
          row_side_colors=data.frame(PollinatorGroup=scentpollnet.class), 
          row_side_palette=function(n) pcols.all)

voc.pollgrp.cap <- capscale(sqrt(scentpollnet.area)~scentpollnet.class)
anova(voc.pollgrp.cap)

plot(voc.pollgrp.cap, type="text")

```


## chemical class x pollinator group bipartite
```{r, chemical class x pollinator group bipartite}

#make vector with compound class and all scent compounds
vol.class <-deframe(select(compound.class, compound_long, major_class) )

#turns scentpollnet matrix to data frame then pivots longer to have 2 cols called chemical and visits

chemical.taxa <- left_join(plantcompoundemission, plantpollinatorvisits,relationship = "many-to-many") %>% left_join(polls.class.dataframe) %>% left_join(compound.class, by=c("compound"= "compound_long")) %>% group_by(pollinator_group, major_class) %>% summarise(visits=sum(visits)) %>% pivot_wider(names_from = major_class, values_from = visits) %>% column_to_rownames("pollinator_group") %>% as.matrix()



#chemical class & pollinator group network
# how do I incorporate chemical class instead of compounds? 
#make data frame with chemical class and pollinator family - use scent.net & chemical.class
#and use scentpollnet but scentpollnet compounds in different order than scent.net
plotweb(sqrt(chemical.taxa), text.rot=90, method="normal", col.high=pal[3], bor.col.high=pal[3], col.low=pcols.all, bor.col.low=pcols.all, col.interaction=pal[5], bor.col.interaction=pal[5])



library(bipartite)
library(vcd)

#side quest
mosaic(chemical.taxa)
mosaic(net)

chisq.test(chemical.taxa) #p=1 so this means that no specialist compound classes. and vise versa. nobody is specialized 

```


## relative peak area x visits
```{r, relative peak area x visits}

#value = number of 
heatmaply(scentpollnet.area, scale="none", showticklabels = c(F,T), margins= c(0,NA,0,0),
          scale_fill_gradient_fun = ggplot2::scale_fill_gradient(low = "white", high = "#000050", trans="log1p"),
          distfun=vegdist, 
          hclustfun=function(x) hclust(x, method="mcquitty"), 
          #row_side_colors = data.frame(P=plants.majorpoll[rowSums(net)>0]),
          #row_side_palette=function(n) pcols, 
          row_side_colors=data.frame(PollinatorGroup=scentpollnet.class), 
          row_side_palette=function(n) pcols.all)

```


# Rarifaction
```{r, Rarifaction}
#species accumulation curves
#figure out what percent Pauls data catpured the whole pollinator community
#pull out 1 random 1 hr sampling period and say how many pollinators observered, then do this again and again randomly - variation in samples = standard error y axis= number of species, x= number of pollinator observations 

#class= bee, fly, butterfly, hummingbird
#xaxis is number of plant species observed (if you did the whole summer but only looked at 1 species and then next summer looked at 2 species, etc.)
#

#simplify net.long to only have numbers in it so that accumulation curve will work 
#rows are observation "units" and columns are pollinators
net.wide <- net.long %>% select(pollinator, interactions) %>% mutate(index=row_number()) %>% 
    pivot_wider(names_from=pollinator, values_from = interactions) %>% mutate(across(everything(),~replace_na(.x, 0))) %>% select(-index) %>% as.matrix()

for(class in unique(polls.class)) { #could replace class with family
  class_subset <- net[,polls.class==class] #making accumulation curve for each pollinator class
  class_sa <- vegan::specaccum(class_subset, permutations = 999) 
  plot.new()
  plot(class_sa, col = as.integer(factor(class))+1, add = class != "bee", lwd=2, 
       xlab="Pollinator Observations", ylab="Pollinator Species", main="Pollinator Species accumulation curve", sub=class)
}
legend("bottomright", unique(polls.class), 
       col = 2:5, pch = 19, title = "Class")

sa<- vegan::specaccum(net.wide,permutations=100, method="exact")
plot(sa) 

#Pauls total pollinator observations 8hrs/wk * 42wks = 336 hours total

visitationrate <- nrow(net.long)/336 #15.33 unique p-p observations per hr (observation can include multiple visits)
#observation=within a 15min period how many p-p interactions did we see, total number of links observed
2000/visitationrate # 130 hrs per treatment ( 2 treatments = 260 hrs per year)

#then based on my observation hours, what percent of the pollinator community could be captured


```

# Normalized Degree

## Normalized degree for p-p
```{r,Normalized degree for p-p}

library(coin)
library(rstatix)
ND_poll<-ND(net, normalised = T)$higher 

#creates dataframe with normalized degree for each pollinator and pollinator class (same as data.frame)
ND.poll.class <- tibble(ND=ND_poll, polls.class=polls.class) 

ND.poll.class$ND <- as.numeric(ND.poll.class$ND)
ND.poll.class$polls.class <- as.factor(ND.poll.class$polls.class)

kruskal_test(ND~polls.class, data=ND.poll.class)

ggplot(ND.poll.class, aes(x= polls.class, y=ND)) +geom_boxplot()



```

## Normalized degree for VOC-pollinator
```{r, normalized degree for VOC-pollinator}
library(rstatix)

#ND for pollinators in scent network
ND_poll_scent<-ND(scentpollnet, normalised = T)$lower 

#ND of VOC chemical class
ND_scent_poll<-ND(scentpollnet, normalised = T)$higher


#creates dataframe with normalized degree for each pollinator and pollinator class (same as data.frame)
ND.poll <-  tibble(ND=ND_poll_scent, polls.class=polls.class)

#kruskal_test doesn't like characters
ND.poll$ND <- as.numeric(ND.poll$ND)
ND.poll$polls.class <- as.factor(ND.poll$polls.class)
  
  
kruskal_test(ND~polls.class, data=ND.poll)

ggplot(ND.poll, aes(x= polls.class, y=ND)) +geom_boxplot()



#creates dataframe with normalized degree for each VOC and chemical class (same as data.frame)
ND.scent <- tibble(ND=ND_scent_poll, vols.class=compound.class$major_class) 
  
kruskal_test(ND~vols.class, data=ND.scent)

ggplot(ND.scent, aes(x= vols.class, y=ND)) +geom_boxplot()

```

## Normalized visits - home cooked
```{r, normalized visits}
#created a function similar to normalized degree(ND) but ND looks at presence/absence in the network where normalized visits (NV) looks at the normalized weighted visits/interactions. This accounts for variation in the amount each plant or compound is visited and give those with higher interaction frequency greater weight or contribution to the network  

normalized.visits <- function (web, normalised = TRUE) 
{

  websum <- sum(web) #takes sum of all interactions in the web
  dlower <- rowSums(web)
  dhigher <- colSums(web)
  Nlow <- Nhigh <- 2
  if (normalised) {
    Nlow <- websum 
    Nhigh <- websum
  }
  low <- dlower/Nlow #weighting the interactions by dividing rowsums by the sum of all links in the network
  names(low) <- rownames(web) #dividing colsums by the sum of all links in the network
  high <- dhigher/Nhigh
  names(high) <- colnames(web)
  list(lower = low, higher = high)
}
```


## Weighted normalized visits  for p-p (pollinators only)- home cooked
```{r, weighted normalized visits  for p-p (pollinators only)}
#Which pollinators have the most visits. of all the visits recorded, what percentage of them were by that pollinator (for a given plant what percentage of visits does it get out of the whole meadow, for a pollinator what percentage of visits does it give out of all visits)

#normalized visits for pollinators in scent net
NV_poll<-normalized.visits(net, normalised = T)$higher 

#creates dataframe with normalized degree for each pollinator and pollinator class (same as data.frame)
NV.poll.class <- tibble(NV=NV_poll, polls.class=polls.class) 

#kruskal_test won't work as.character, need to change to numeric and factor
NV.poll.class$NV <- as.numeric(NV.poll.class$NV)
NV.poll.class$polls.class <- as.factor(NV.poll.class$polls.class)

kruskal_test(NV~polls.class, data=NV.poll.class)

ggplot(NV.poll.class, aes(x= polls.class, y=NV)) +geom_boxplot()
#only a few species making most of the visits
#1 bee responsible for over 40% of visits


```

## Normalized visits for scent network
```{r, normalized visits for scent network}

#normalized visits for pollinators in scent net
#which pollinator class visits the most amount of compounds weighted by the number of visits
NV_poll_scentnet<-normalized.visits(scentpollnet, normalised = T)$lower 

#creates dataframe with normalized degree for each pollinator and pollinator class (same as data.frame)
NV.poll.class.scentnet <- tibble(NV=NV_poll_scentnet, polls.class=polls.class) 
  
#kruskal_test won't work as.character, need to change to numeric and factor
NV.poll.class.scentnet$NV <- as.numeric(NV.poll.class.scentnet$NV)
NV.poll.class.scentnet$polls.class <- as.factor(NV.poll.class.scentnet$polls.class)

kruskal_test(NV~polls.class, data= NV.poll.class.scentnet)

ggplot(NV.poll.class.scentnet, aes(x= polls.class, y=NV)) +geom_boxplot()
#super generalist bees

#normalized visits for VOCs in scent net
#which compound class are most visited
NV_voc<-normalized.visits(scentpollnet, normalised = T)$higher 

#creates dataframe with normalized degree for each pollinator and pollinator class (same as data.frame)
NV.vols.class <- tibble(NV=NV_voc, vols.class=compound.class$major_class) 
  

k_t.vols.class <- kruskal_test(NV~vols.class, data=NV.vols.class)


library(coin)
library(PMCMRplus) #for posthoc
library(PMCMR)

#posthoc_vols.class <- posthoc.kruskal.nemenyi.test(NV.vols.class$vols.class, NV.vols.class$NV, dist = "tukey")

ggplot(NV.vols.class, aes(x= vols.class, y=NV)) +geom_boxplot()
#tells you what vocs get the most visits
#no difference in visitation rate to compound classes

```

#Modularity 

## Modularity for plant-pollinator network 
```{r, modularity for net}
library(vcd)

modules.net <- computeModules(sqrt(net))

plotModuleWeb(modules.net, labsize=.5)

module.net.list <- listModuleInformation(modules.net)

flatten(module.net.list[[2]])


pollinator.modules <- tibble(module=1:5) %>% mutate(pollinator=map(module, ~module.net.list[[2]][[.x]][[2]])) %>% unnest(pollinator) %>% left_join(polls.class.dataframe) %>% count(module, pollinator_group) %>% pivot_wider(names_from = pollinator_group, values_from = n, values_fill = 0) %>% column_to_rownames("module") %>% as.matrix()

chisqr.polls <- chisq.test(pollinator.modules)
residules.chisqr.polls <- residuals(chisqr.polls)

mosaic(t(pollinator.modules), shade = T, gp=shading_hcl)

#test to see p-p network modules
#mosaic(net, shade = T, gp=shading_hcl)
```

## Modularity for scent-pollinator network

```{r, modularity for scent net}
modules.scentnet <- computeModules(sqrt(t(scentpollnet)))

#plotModuleWeb(modules.scentnet)

module.scentnet.list <- listModuleInformation(modules.scentnet)


pollinator.modules <- tibble(module=1:4) %>% mutate(pollinator=map(module, ~module.scentnet.list[[2]][[.x]][[2]])) %>% unnest(pollinator) %>% left_join(polls.class.dataframe) %>% count(module, pollinator_group) %>% pivot_wider(names_from = pollinator_group, values_from = n, values_fill = 0) %>% column_to_rownames("module") %>% as.matrix()

chisqr.polls <- chisq.test(pollinator.modules)
residules.chisqr.polls <- residuals(chisqr.polls)

mosaic(t(pollinator.modules), shade = T, gp=shading_hcl, labeling = vcd::labeling_border(rot_labels = c(0, 0)))


#chemical class modularity 


chemical.modules <- tibble(module=1:4) %>% mutate(compound_long=map(module, ~module.scentnet.list[[2]][[.x]][[1]])) %>% unnest(compound_long) %>% left_join(compound.class) %>% count(module, major_class) %>% pivot_wider(names_from = major_class, values_from = n, values_fill = 0) %>% column_to_rownames("module") %>% as.matrix()

mosaic(t(chemical.modules), shade = T, gp=shading_hcl, labeling = vcd::labeling_border(rot_labels = c(0, 0)))

```

# Stacked bar chart - who's visiting who 

### Plot 1 -pollinator perspective
#Stacked bar chart with flowers visited by each pollinator
#Looks at the top 20 plants and top 75 pollinators (interactions square rooted to adjust scale on the figure)
#x= interactions, y=pollinators, color=plant

### Plot 2 - plants perspective
#Stacked bar chart with what pollinators visited each plant species
#45 plant species, 18 pollinators
#x= interactions, y=plant, color=pollinator

```{r, stacked bar chart with flowers visited by each pollinator}
library(ggplot2)
library(tidyverse)
library(RColorBrewer)
mypalette= c(brewer.pal(8, "Set2"), brewer.pal(12, "Set3"))

#looks at top 20 plants and top 75 pollinators (interactions sqrt to adjust scale on figure)
#pollinator perspective
ggplot(net.long %>% mutate(plant=fct_lump_n(plant, 18), pollinator=fct_lump_n(pollinator, 75)), aes(x=sqrt(interactions), y=pollinator, fill=plant)) + geom_col() + scale_fill_manual(values=mypalette)

#plant perspective
ggplot(net.long %>% mutate(plant=fct_lump_n(plant, 45), pollinator=fct_lump_n(pollinator, 18)), aes(x=sqrt(interactions), y=plant, fill=pollinator)) + geom_col() + scale_fill_manual(values=mypalette)

```

# Phenology
#Uses Paul's phenology data to create stackplot

## Plot 1 - Flower Phenology
#Panels are years, x= week number, y= flower count, color= plant species
## Plot 2 - flower phenology heatmap
## Plot 3 - Pollinator Phenology 
#Panels are years, x= week number, y= interactions, color= pollinator
## Plot 4 - flower phenology heatmap
## Plot 5 - Scent Phenology
#weighted average of flower scents and mean is weighted by how many flowers there are that week
#shows relative amount of that compound out of the total scent in the meadow that week
#each color is a compound, value= total emissions
## Plot 6 - heatmap scent phenology

```{r, phenology}
phenology <- read_sheet("15Jnx8OWMzpakC0YvJWmZMmaRSnA0X-7HBjymDsvUfjY")

#stack plots and heatmaps 

#Flowers#
ggplot(phenology, aes(x=week_num, y=flower_count, fill= plant )) + geom_col() + scale_fill_manual(values=sample(rainbow(46))) +facet_wrap(vars(year))

#heatmap
ggplot(phenology, aes(x=week_num, y=plant, fill= sqrt(flower_count ))) + geom_tile() + scale_fill_viridis_c()  + facet_wrap(vars(year))

#pollinators#

ggplot(net.long, aes(x=week_num, y=interactions, fill= pollinator )) + geom_col() + scale_fill_manual(values=sample(rainbow(93))) +facet_wrap(vars(year))

#heatmap
ggplot(net.long, aes(x=week_num, y=pollinator, fill= sqrt(interactions ))) + geom_tile() + scale_fill_viridis_c()  + facet_wrap(vars(year))

#scent#
#number of flowers per week and multiple by mean scent of that species

#how many flowers are open each week
flowers.per.week <- phenology %>% group_by(year, week_num, plant) %>%  
                    summarise(flower_count=sum(flower_count))

#ideally want for each week, 1 average weighted mean of scent compound 
  #but we only have a few scent samples so just taking the mean of scent compounds for each plant

#flowers per week percentage 
flower.percentage <- flowers.per.week %>% group_by(year, week_num) %>% 
        mutate(flower_count=flower_count/sum(flower_count)) %>% 
        pivot_wider(names_from = c(year,week_num), values_from = flower_count, values_fill = 0) %>% 
        filter(plant%in%rownames(scent.net)) %>% 
        arrange(match(plant, rownames(scent.net)))%>%  #matches scent.net plant order
        column_to_rownames("plant")  %>% as.matrix()
#change names in pauls data

scentxphenology <- t(flower.percentage) %*% scent.net[rownames(flower.percentage),]  
#values in matrix = weighted average of flower scents and mean is weighted by how many flowers there are that week

#replaces Nans with 0
scentxphenology[is.nan(scentxphenology)] <- 0

#ggplot likes long format
scent.phenology <- scentxphenology %>% as.data.frame() %>%  rownames_to_column("yearweek") %>% separate(yearweek, into = c("year", "week_num")) %>% mutate(year=as.integer(year), week_num= as.integer(week_num)) %>%  pivot_longer(all_of(colnames(scent.net)))

ggplot(scent.phenology, aes(x=week_num, y=value, fill= name )) + geom_col() + scale_fill_manual(values=sample(rainbow(355)), guide="none") +facet_wrap(vars(year))

#stack bar plot of scent compounds in each plant species (gives total emission of each compound in each plant species)
ggplot(scent.net.long, aes(x=emissions, y=plant, fill= compound )) + geom_col() + scale_fill_manual(values=sample(rainbow(354)), guide="none") 


#heatmap - scent x phenology
ggplot(scent.phenology, aes(x=week_num, y=name, fill= sqrt(value ))) + geom_tile() + scale_fill_viridis_c()  + facet_wrap(vars(year))
```

# Mega table
## flower and poll traits
### VOCS

```{r, VOC megatable}
#number of compounds each plant species has
#total emissions for each species
#diversity of scents (shannon diversity)
library(tidyverse)

scent.net.long <- scent.net %>% as.data.frame() %>% rownames_to_column("plant") %>% #average peak area
  pivot_longer(-plant, names_to = "compound", values_to = "emissions") %>% filter(emissions!=0)


compound.class.percentage <- scent.net.long %>% left_join(compound.class, by=c(compound="compound_long")) %>%  group_by(plant, major_class) %>%  summarise(emissions=sum(emissions)) %>%  #gives total emissions for each compound class
        mutate(emissions=emissions/sum(emissions)) %>%  #relative amount of each compound class in species scent
        pivot_wider(names_from = major_class, values_from = emissions, names_prefix = "percent_", values_fill = 0) #makes column for each compound class and gives percentage of that compound class out of the total emissions for that species 


#rare vs common compounds (mean rarity)
##for each compound, how many times does it occur in the dataset? 

compound.rarity <- scent.net.long %>%  count(compound) %>%  #number of species the compound occurs in
          mutate(rarity=n/nrow(scent.net))  #the percentage of species the compound occurs in
 
weighted.scent.rarity <- scent.net.long %>% left_join(compound.rarity) %>% group_by(plant) %>%    
            mutate(emissions=emissions/sum(emissions)) %>%  #makes emissions -> relative emissions    
            mutate(weighted_scent_rarity = emissions*rarity) %>% #multiplies emissions x rarity to get weighted average
            summarise(weighted_scent_rarity= sum(weighted_scent_rarity)) #then add the different parts of the average
 #rarity score of 1 means this compound is found in all the plant species, 0= no other species has these compounds 
#mertensia has 0.70 rarity - the weighted average of all the compounds rarity; 70% of compounds (or total emissions) are shared, 30% of compounds or total emissions other species don't have



scent.summary <- tibble(plant=rownames(scent.net), total_emissions= rowSums(scent.net), number_compounds=rowSums(scent.net>0),scent_shannon_diversity= diversity(scent.net, index="shannon")) %>%
  left_join(weighted.scent.rarity) %>%     
  left_join(compound.class.percentage) 
```

### floral traits summary
```{r, floral traits megatable}

#pollinators that visit plants

#Percentage of visits by each pollinator family to each plant species
pollinator.family.percentage <- net.long %>% group_by(plant, pollinator_family) %>%  summarise(interactions=sum(interactions)) %>%  #gives sum of interactions for each pollinator family
        mutate(interactions=interactions/sum(interactions)) %>%  #relative amount of each pollinator family visiting each flower species
        pivot_wider(names_from = pollinator_family, values_from = interactions, names_prefix = "percent_", values_fill = 0)

#Percentage of visits by each pollinator group to each plant species
pollinator.group.percentage <- net.long %>% group_by(plant, pollinator_group) %>%  summarise(interactions=sum(interactions)) %>%  #gives sum of interactions for each pollinator group
        mutate(interactions=interactions/sum(interactions)) %>%  #relative amount of each pollinator group visiting each flower species
        pivot_wider(names_from = pollinator_group, values_from = interactions, names_prefix = "percent_", values_fill = 0)

#rarity - how generalized the pollinator is
pollinator.rarity <- net.long %>% count(plant, pollinator) %>%  #adds how many rows of interactions between plant & poll species
          count(pollinator, name="number_plants_visited") %>%  #number of plants the pollinator goes to
          mutate(rarity=number_plants_visited/nrow(net))  #the percentage of plant species the pollinator visits in the meadow

#gives for each plant species, which pollinators visited and their relative contributions to total number of visits
 net.long.relative.interactions <- net.long %>% group_by(plant, pollinator) %>% 
            summarise(interactions=sum(interactions)) %>% 
            left_join(pollinator.rarity) %>% 
            group_by(plant) %>%    
            mutate(interactions=interactions/sum(interactions))
 
 #percent of interactions that come from each pollinator species    
 weighted.pollinator.rarity <-   net.long.relative.interactions %>% mutate(weighted_poll_rarity = interactions*rarity) %>% #multiplies interactions x rarity to get weighted average
            summarise(weighted_poll_rarity = sum(weighted_poll_rarity)) 

flower.visitor.summary <- tibble(plant=rownames(net), total_visits= rowSums(net), number_pollspecies_visited=rowSums(net>0),pollinator_shannon_diversity= diversity(net, index="shannon")) %>%
  left_join(weighted.pollinator.rarity) %>% 
  left_join(pollinator.family.percentage) %>% left_join(pollinator.group.percentage)

megatable <- scent.summary %>% full_join(flower.visitor.summary) #full join bc pauls data and scent data plants don't match
```

# Correlations
## Plot 1 - heatmap of correlation table
## Plot 2 - weighted scent and weighted pollinator visits correlation scatter plot
## Plot 3 - percent_hesperiidae x nitrogenous vocs correlation scatter plot
```{r, correlations}
library(pheatmap)
library(smatr)


correlation.table <- megatable %>% column_to_rownames("plant") %>% cor(use="na.or.complete")

pheatmap(correlation.table, scale="none", clustering_method = "mcquitty", color=colorRampPalette(c("blue","white", "red"))(200),
         breaks = seq(-1,1, by=0.01)) #which ones it labels on the scale

#scatter plot with just weighted scent and weighted pollinator visits
weighted.scent.poll <- ggplot(megatable, aes(x=weighted_poll_rarity, y=weighted_scent_rarity, color=number_pollspecies_visited)) + geom_point()+geom_smooth() + geom_text(aes(label=plant))     

print(weighted.scent.poll)
#the most common volatiles get the most visits from the most generalized pollinators

sma.weighted.scent.poll <- sma(weighted_poll_rarity~weighted_scent_rarity, data=megatable )

summary(sma.weighted.scent.poll)

#percent_hesperiidae x nitrogenous vocs
ggplot(megatable, aes(x=percent_nitrogenous, y=percent_lycaenidae, color=number_pollspecies_visited)) + geom_point()+geom_smooth() + geom_text(aes(label=plant))

```


##pollinator trait summary
```{r}


```

