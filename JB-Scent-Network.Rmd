---
title: "JB-Scent-Net"
author: "Janelle Bohey"
date: "2023-11-28"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, comment="  ", cache=TRUE, fig.width=14, fig.asp=.678)
library(openxlsx)
library(data.table)
library(RColorBrewer)
pal <- brewer.pal(5,"Set2")
#library(heatmaply)
library(bipartite)
data(mosquin1967)
library(vegan)
library(phytools)
library(taxize)
#remotes::install_github("ropensci/brranching")
library(brranching)
library(rotl)
library(dendextend)
library(tidyverse)
library(heatmaply)

```

#load network
```{r data}
#load network
setwd("~/Desktop/Scent-Net")
net.long <- read_sheet("1plhxbVh5IQLNVMazqO4OvfM3X6vbll_Y6BTMJ94bkI4", na=c("","na", "NA")) %>%    
      mutate(pollinator_group= if_else(pollinator=="papilio_gothica", "butterfly", pollinator_group)) %>% #fix papilio_gothica from bee -> butterfly
      mutate(plant= recode(plant,senecio_tall_int = "senecio_integerrimus", agoceris_glauca = "agoseris_glauca", agoceris_aurantiaca="agoseris_aurantiaca", hydrophyllum_fendeleri="hydrophyllum_fendleri"))

net <- net.long %>% select(plant, pollinator, interactions) %>% pivot_wider(names_from = plant, values_from = interactions, values_fn= sum, values_fill= 0) %>%  #pivots data set longer so plants as columns and pollinators as rows, replaces NAs with zeros
    column_to_rownames("pollinator") #pollinators are in first column, makes them into rownames; #deletes the first pollinators column


net <- as.matrix(t(net)) # turns it from dataframe to matrix bc packages like matrix; t transposes (turns dataset sideways - rows -> columns; columns -> rows) 
polls <- colnames(net) #now pollinators are column names
plants<-rownames(net)
snet <- sortweb(net) #sort by row & column totals; sorted rows by rowsums and columns by column sums. Biggest numbers in top left of matrix



```

#load scent 
```{r}
#Go to comm_vols for code to make scent.net
#Loads in vol, filters with bouquet, takes mean of each voc for each species 
scent.net <- read_csv("data/Volatiles_by_species_mean.csv") %>% column_to_rownames("species") %>% #species are now rownames
    as.matrix() #network analysis likes matrix 

```

##match paul's plants with the plants we have vocs for
```{r}
scentplants<-rownames(scent.net) #%>% tolower() %>%  str_replace(" ", "_")

paulsplants <- plants

#plants not in both datasets 
setdiff(scentplants, paulsplants) #gives us bonus plants
setdiff(paulsplants, scentplants) 

bothplants <- intersect(scentplants, paulsplants) #plants found in amanda and paul data
```


# Pollinator groups and family
```{r }
polls.count <-count(net.long, pollinator_group,pollinator_family, pollinator) #counting number of rows for each pollinator
polls.class <- tibble(pollinator=polls) %>%  left_join(polls.count) %>% pull(pollinator_group)
polls.class.dataframe <- tibble(pollinator=polls) %>%  left_join(polls.count)
polls.family <- tibble(pollinator=polls) %>%  left_join(polls.count) %>% pull(pollinator_family)
polls.order.all <- polls.class

#net.grp.all has all of pauls 45 plant species 
#net.grp only has plant species found in Amanda's and paul's datasets
net.grp.all <- aggregate(.~ polls.class, as.data.frame(t(net)), sum) #lump network by pollinator class; plants columns, pollinators rows
rownames(net.grp.all) <- net.grp.all[,1] #make plants rows, pollinators column names
net.grp.all[,1] <- NULL
net.grp.all <- as.matrix(t(net.grp.all)) #transposes matrix
net.grp<- net.grp.all[bothplants,] 

net.cut <- net[bothplants,]

```


# Plant-pollinator network

##Pollinator groups
```{r pollgroups}
#Tells you plants major pollinator
plants.majorpoll <- setNames(factor(colnames(net.grp)[apply(net.grp, 1, which.max)]), rownames(net.grp))

#sets colors for ALL 5 pollinator groups
pcols.all <- setNames(brewer.pal(5,"Set2"), colnames(net.grp))

#Four colors for each major pollinator group
pcols <- pcols.all[ levels(plants.majorpoll)]

```


##Heatmap
```{r heatmap, fig.asp=1}

heatmaply(net, scale="none", showticklabels = c(F,T), margins= c(0,NA,0,0),
          scale_fill_gradient_fun = ggplot2::scale_fill_gradient(low = "white", high = "#000050", trans="log1p"),
          distfun=vegdist, 
          hclustfun=function(x) hclust(x, method="mcquitty"), 
          row_side_colors = data.frame(P=plants.majorpoll[rowSums(net)>0]),
          row_side_palette=function(n) pcols, 
          col_side_colors=data.frame(PollinatorGroup=polls.class), 
          col_side_palette=function(n) pcols.all)
```

##Matrix plot
```{r matrixplot, fig.asp=.2}
#interaction matrix plot
visweb(net, type="nested", circles=T, boxes=F, circle.max=1.2)
```

##Web plot
```{r webplot}
#interaction web plot
plotweb(sqrt(net), empty=F, text.rot=90, method="cca", col.high=pcols.all[polls.order.all], col.low=pcols[plants.majorpoll], col.interaction=pcols.all[polls.order.all], bor.col.interaction=pcols.all[polls.order.all], bor.col.high=pcols.all[polls.order.all], bor.col.low=pcols[plants.majorpoll])
```

#Network topography
```{r topo}
#computes network statistics (like nestedness)
#networkstats <- networklevel(net)
write_csv(enframe(networkstats), "data/p-p network stats.csv")

```

# Scent network
##Heatmap
```{r heatmap.s, fig.asp=1}
#get heatmap code from NEXP 
```

##Web plot VOCs-Plants
```{r webplot.s}
#interaction web plot
#plant-voc bipartite
plotweb(sqrt(scent.net), text.rot=90, method="cca", col.high=pal[2], bor.col.high=pal[2], col.low=pcols[plants.majorpoll], bor.col.low=pcols[plants.majorpoll], col.interaction=pal[5], bor.col.interaction=pal[5])
```

#Plant-scent-pollinator network
##NMDS
```{r nmds}
scent.mds <- metaMDS(sqrt(scent.net.cut), autotransform = F, trace=F)
scent.op <- ordiplot(scent.mds, type="n")
points(scent.op, what="species", pch=3, col="grey50")
points(scent.op, what="sites", cex=1.5, pch=19, col=pcols[plants.majorpoll])
text(scent.op, what="sites", cex=0.8, col=pcols[plants.majorpoll])

```

#cap
```{r}
scent.cap <- capscale(sqrt(scent.net.cut)~plants.majorpoll)
anova(scent.cap)

plot(scent.cap, type="text")
```

##Indicator compounds
```{r indicators}
library(indicspecies)
scent.net.cut <- scent.net[rownames(scent.net)%in% paulsplants, ]

plants.majorpoll.cut <- plants.majorpoll[rownames(scent.net.cut)]
  
mp <- multipatt(as.data.frame(scent.net.cut), plants.majorpoll.cut, control=how(nperm=999))
summary(mp)
```


#Do generalist plants have higher diversity of scent compounds?
```{r generalists}
plants.numlinks  <- rowSums(decostand(net.grp, "pa"))
#polls.classtree <- compute.brlen(polls.classtree$phylo,1)
#library(picante)
#plants.pdlinks   <- pd(net.lump, polls.classtree)$PD
plants.numcompounds <- rowSums(decostand(scent.net.cut, "pa"))
plants.sumcompounds <- rowSums(scent.net.cut)
plants.shannoncompounds <- diversity(scent.net.cut, index="shannon")
plants.shannonlinks <- diversity(net.grp, index="shannon")

scent.diversity <- tibble(numlinks=plants.numlinks, numcompounds=plants.numcompounds, sumcompounds=plants.sumcompounds, shannoncompounds=plants.shannoncompounds, shannonlinks=plants.shannonlinks)

ggplot(scent.diversity, aes(y=numcompounds, x=numlinks))+
    geom_point()+ geom_smooth()

#plot(plants.numcompounds~plants.pdlinks)

#plot(plants.shannoncompounds~plants.pdlinks)

ggplot(scent.diversity, aes(y=shannoncompounds, x=shannonlinks))+
    geom_point()+ geom_smooth()


ggplot(scent.diversity, aes(y=shannoncompounds, x=plants.majorpoll.cut))+
    geom_point()+ geom_smooth()

ggplot(scent.diversity, aes(y=numcompounds, x=plants.majorpoll.cut))+
    geom_point()+ geom_smooth()

ggplot(scent.diversity, aes(y=sumcompounds, x=plants.majorpoll.cut))+
    geom_point()+ geom_smooth()


```

#VOC-pollinator network
```{r}
#interaction web plot
#voc-pollinator bipartite

#make dataframe with vocs and pollinators
##change scent.net to long format
plantcompoundemission <- scent.net.cut %>% as.data.frame() %>% rownames_to_column("plant") %>% pivot_longer(-plant, names_to = "compound", values_to = "emissions") %>% filter(emissions!=0)

plantpollinatorvisits <- net.cut %>% as.data.frame() %>% rownames_to_column("plant") %>% pivot_longer(-plant, names_to = "pollinator", values_to = "visits")

scentpollnet <- left_join(plantcompoundemission, plantpollinatorvisits) %>%  group_by(pollinator, compound) %>% summarise(visits=sum(visits)) %>%  pivot_wider(names_from = "compound", values_from = "visits") %>% column_to_rownames("pollinator") %>% as.matrix()

scentpollnet.class <- tibble(pollinator=rownames(scentpollnet)) %>% left_join(polls.class.dataframe) %>% pull(pollinator_group)

#plot bipartite network
plotweb(sqrt(scentpollnet), text.rot=90, method="cca", col.high=pal[2], bor.col.high=pal[2], col.low=pcols[scentpollnet.class], bor.col.low=pcols[scentpollnet.class], col.interaction=pal[5], bor.col.interaction=pal[5])
```

##Heatmap scent-net
```{r heatmap, fig.asp=1}

heatmaply(scentpollnet, scale="none", showticklabels = c(F,T), margins= c(0,NA,0,0),
          scale_fill_gradient_fun = ggplot2::scale_fill_gradient(low = "white", high = "#000050", trans="log1p"),
          distfun=vegdist, 
          hclustfun=function(x) hclust(x, method="mcquitty"), 
          #row_side_colors = data.frame(P=plants.majorpoll[rowSums(net)>0]),
          #row_side_palette=function(n) pcols, 
          row_side_colors=data.frame(PollinatorGroup=scentpollnet.class), 
          row_side_palette=function(n) pcols.all)

```

